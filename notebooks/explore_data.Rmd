This file is the development of `src/process_data.R`.

```{r}
library(tidyverse)
library(readxl)
library(openxlsx)
```

```{r}
url <- "https://www.cihi.ca/sites/default/files/document/health-workforce-canada-2019-2023-overview-data-tables-en.xlsx"
download.file(url, "../data/raw/raw_data.xlsx", mode = "wb")
```

```{r}
raw_data_ <- read_excel("../data/raw/raw_data.xlsx", sheet=3, skip=1, n_max=37)
```

```{r}
raw_nl_data <- read.xlsx(
  "../data/raw/raw_data.xlsx",
  sheet=4,
  startRow=2,
  rows=seq(2, 185),
  fillMergedCells = TRUE)

processed_nl_data <- raw_nl_data

colnames(processed_nl_data) <- c("profession_type",
                                 "year",
                                 "count",
                                 "count_per_100000",
                                 "percent_female",
                                 "percent_age_under_30",
                                 "percent_age_30_to_59",
                                 "percent_age_over_60") 

processed_nl_data <- processed_nl_data |>
  filter(profession_type == "Family medicine" |
        profession_type == "Nurse practitioners") |>
  mutate(province_territory = "Newfoundland and Labrador")
```

```{r}

read_save_process_province_territory_data <- function(sheet_number, name) {
  raw_province_territory_data <- read.xlsx(
    "../data/raw/raw_data.xlsx",
    sheet=sheet_number,
    startRow=2,
    rows=seq(2, 185),
    fillMergedCells = TRUE) |>
    select(1:8)
  
  processed_province_territory_data <- raw_province_territory_data
  
  colnames(processed_province_territory_data) <- c(
    "profession_type",
    "year",
    "count",
    "count_per_100000",
    "percent_female",
    "percent_age_under_30",
    "percent_age_30_to_59",
    "percent_age_over_60") 

  processed_province_territory_data <- processed_province_territory_data |>
    filter(profession_type == "Family medicine" |
    profession_type == "Nurse practitioners") |>
    mutate(province_territory = name)
  
  return(processed_province_territory_data)
}
```

```{r}
names <- c("Newfoundland and Labrador",
           "Prince Edward Island",
           "Nova Scotia",
           "New Brunswick",
           "Quebec",
           "Ontario",
           "Manitoba",
           "Saskatchewan",
           "Alberta",
           "British Columbia",
           "Yukon",
           "Northwest Territories",
           "Nunavut")

full_data <- df <- tibble(
  profession_type = character(),
  year = integer(),
  count = integer(),
  count_per_100000 = numeric(),
  percent_female = numeric(),
  percent_age_under_30 = numeric(),
  percent_age_30_to_59 = numeric(),
  percent_age_over_60 = numeric(),
  province_territory = character()
)

for (i in seq_along(names)) {
  sheet_number = i + 3
  
  data = read_save_process_province_territory_data(
    sheet_number=sheet_number,
    name=names[i])
  
  full_data <- rbind(full_data, data)
}
```

```{r}
population_data <- read.xlsx(
  "../data/raw/raw_data.xlsx",
  sheet=17,
  startRow=2,
  rows=seq(2, 15)) |>
  select(1:6)

colnames(population_data) <- c("province_territory", "2019", "2020", "2021", "2022", "2023")

population_data <- population_data |>
  pivot_longer(c("2019", "2020", "2021", "2022", "2023"),
               names_to="year",
               values_to = "population") |>
  mutate(year = as.numeric(year))
```

```{r}
read_save_process_province_territory_data(
     sheet_number=6,
     name="Nova Scotia")
```

```{r}
raw_ns_data <- read.xlsx(
  "../data/raw/raw_data.xlsx",
  sheet=6,
  startRow=2,
  rows=seq(2, 185),
  fillMergedCells = TRUE) |>
  select(1:8)

processed_nl_data <- raw_nl_data

colnames(processed_nl_data) <- c("profession_type",
                                 "year",
                                 "count",
                                 "count_per_100000",
                                 "percent_female",
                                 "percent_age_under_30",
                                 "percent_age_30_to_59",
                                 "percent_age_over_60") 

processed_nl_data <- processed_nl_data |>
  filter(profession_type == "Family medicine" |
        profession_type == "Nurse practitioners") |>
  mutate(province_territory = "Nova Scotia")
```

```{r}
full_data <- full_join(full_data,
                       population_data,
                       by = join_by(year, province_territory)
```

```{r}
head(population_data)
```

```{r}
write_csv(full_data, "../data/processed/processed_data.csv")
```
